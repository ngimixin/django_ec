{% load static humanize cart_extras %}
<h4 class="d-flex justify-content-between align-items-center mb-3">
  <span class="text-dark">カート詳細</span>
  <span class="badge bg-primary rounded-pill">総個数 {{ total_quantity }}</span>
</h4>
<ul class="list-group mb-3">
  {% if items %}
    {% for item in items %}
      <li class="list-group-item d-flex justify-content-between lh-sm">
        <div>
          <h6 class="my-0">
            <a href="{% url 'products:product_detail' item.product.id %}">{{ item.product.name }}</a>
          </h6>
          {# 在庫数に基づいた数量選択肢を使って数量変更フォームを表示 #}
          {% with quantity_range=item_quantity_ranges|get_item:item.product.id %}
            {% if quantity_range %}
              <form method="post"
                    action="{% url 'products:cart_item_update' item.id %}"
                    class="mt-1 d-flex align-items-center gap-2 cart-quantity-form"
                    data-item-id="{{ item.id }}"
                    data-update-url="{% url 'products:cart_item_update' item.id %}">
                {% csrf_token %}
                <label class="text-body-secondary mb-0" for="item-quantity-{{ item.id }}">数量:</label>
                <select id="item-quantity-{{ item.id }}"
                        name="quantity"
                        class="form-select form-select-sm d-inline w-auto cart-quantity-select">
                  {% for qty in quantity_range %}
                    <option value="{{ qty }}" {% if qty == item.quantity %}selected{% endif %}>{{ qty }}</option>
                  {% endfor %}
                </select>
              </form>
            {% else %}
              <small class="text-danger d-block">在庫切れのため削除してください</small>
            {% endif %}
          {% endwith %}
        </div>
        <div class="d-flex align-items-center gap-2">
          <!-- 1つあたりの価格 -->
          <span class="text-body-secondary">¥{{ item.product.price|intcomma }}</span>
          <!-- 削除ボタン（POST専用） -->
          <form method="post"
                action="{% url 'products:cart_item_delete' item.id %}"
                class="cart-item-delete-form">
            {% csrf_token %}
            <button type="submit"
                    class="btn btn-sm text-nowrap {% if item.product.stock <= 0 %}btn-danger{% else %}btn-outline-danger{% endif %}">
              <i class="bi bi-trash"></i>
              削除
            </button>
          </form>
        </div>
      </li>
    {% endfor %}
  {% else %}
    <li class="list-group-item">カートに商品がありません。</li>
  {% endif %}
  {% if promotion_code and promotion_discount_amount %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <div>プロモーションコード ({{ promotion_code.code }})</div>
      <div class="d-flex align-items-center gap-2">
        <strong class="text-danger">-￥{{ promotion_discount_amount|intcomma }}</strong>
        <form method="post"
              action="{% url 'products:cart_promotion_remove' %}"
              class="promotion-remove-form">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm btn-outline-danger text-nowrap">
            <i class="bi bi-trash"></i>
            解除
          </button>
        </form>
      </div>
    </li>
  {% endif %}
  <!-- 合計 -->
  <li class="list-group-item d-flex justify-content-between">
    <span>合計 ({{ total_quantity }}点)</span>
    <strong>(税込) ￥{{ payable_total|intcomma }}</strong>
  </li>
</ul>
<!-- プロモーションコード入力フォーム -->
<div class="card p-2">
  <form method="post"
        action="{% url 'products:cart_promotion_apply' %}"
        class="promotion-apply-form">
    {% csrf_token %}
    <div class="input-group">
      <input type="text"
             name="promotion_code"
             class="form-control{% if promotion_form.promotion_code.errors %} is-invalid{% endif %}"
             placeholder="プロモーションコード"
             value="{{ promotion_form.promotion_code.value|default_if_none:'' }}">
      <button type="submit" class="btn btn-secondary promotion-apply-button">
        適用
      </button>
    </div>
    {% if promotion_form.promotion_code.errors %}
      <div class="invalid-feedback d-block mt-2">
        {{ promotion_form.promotion_code.errors.0 }}
      </div>
    {% endif %}
  </form>
</div>
