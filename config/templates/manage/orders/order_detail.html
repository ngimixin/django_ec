{% extends "base.html" %}
{% load humanize tz cart_extras %}
{% block title %}
  {{ SITE_TITLE }} | 購入明細：詳細
{% endblock title %}
{% block content %}
  <div class="container px-4 px-lg-5 py-4 manage-order-detail">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="mb-0">購入明細：詳細</h1>
      <a href="{% url 'products:manage_order_list' %}"
         class="btn btn-outline-secondary">一覧へ戻る</a>
    </div>
    <div class="card mb-4">
      <div class="card-header bg-white fw-semibold">注文情報</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <p class="mb-1">
              <strong>注文ID：</strong>{{ order.id }}
            </p>
            <p class="mb-1">
              <strong>注文日時：</strong>{{ order.created_at|localtime|date:"Y-m-d H:i" }}
            </p>
            <p class="mb-1">
              <strong>ステータス：</strong>{{ order.get_status_display }}
            </p>
            {% if order.promotion_code and order.promotion_discount_amount %}
              <p class="mb-1">
                <strong>プロモーションコード：</strong>{{ order.promotion_code.code }}
              </p>
              <p class="mb-1 text-danger">
                <strong>値引き：</strong>-¥{{ order.promotion_discount_amount|intcomma }}
              </p>
            {% endif %}
            <p class="mb-1">
              <strong>合計金額：</strong>¥{{ order.total_amount|intcomma }}
            </p>
          </div>
          <div class="col-md-6">
            <p class="mb-1">
              <strong>お名前：</strong>{{ order.name }}
            </p>
            <p class="mb-1">
              <strong>電話番号：</strong>{{ order.phone|format_phone }}
            </p>
            <p class="mb-1">
              <strong>メール：</strong>{{ order.email }}
            </p>
            <p class="mb-1">
              <strong>住所：</strong>
              <br>
              〒{{ order.postal_code|slice:":3" }}-{{ order.postal_code|slice:"3:" }}
              <br>
              {{ order.address|linebreaksbr }}
            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="card mb-4">
      <div class="card-header bg-white fw-semibold">支払い情報（学習用）</div>
      <div class="card-body">
        <p class="mb-1">
          <strong>カード番号：</strong>**** **** **** {{ order.card_number|slice:"-4:" }}
        </p>
        <p class="mb-0 text-muted">セキュリティのため、有効期限・CVV・名義は表示していません。</p>
      </div>
    </div>
    <div class="card mb-4">
      <div class="card-header bg-white fw-semibold">注文明細</div>
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
          <thead>
            <tr>
              <th>商品名</th>
              <th>単価</th>
              <th>数量</th>
              <th>小計</th>
            </tr>
          </thead>
          <tbody>
            {% for item in items %}
              <tr>
                <td>{{ item.product_name }}</td>
                <td>¥{{ item.price|intcomma }}</td>
                <td>{{ item.quantity }}</td>
                <td>¥{{ item.total_price|intcomma }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card-footer bg-white text-end fw-semibold">合計：¥{{ order.total_amount|intcomma }}</div>
    </div>
  </div>
{% endblock content %}
